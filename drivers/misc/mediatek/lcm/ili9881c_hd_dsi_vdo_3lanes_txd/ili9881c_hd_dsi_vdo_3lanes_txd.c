#ifndef BUILD_LK
#include <linux/string.h>
#endif

#include "lcm_drv.h"

// ---------------------------------------------------------------------------
//  Local Constants
// ---------------------------------------------------------------------------

#define AUXADC_LCM_VOLTAGE_CHANNEL     12
#define AUXADC_ADC_FDD_RF_PARAMS_DYNAMIC_CUSTOM_CH_CHANNEL     1

#define MIN_VOLTAGE (500)     // zhoulidong  add for lcm detect
#define MAX_VOLTAGE (1000)     // zhoulidong  add for lcm detect

#define LCM_ID_ILI9881                                    0x9881

#define REGFLAG_DELAY 0xFC
#define REGFLAG_END_OF_TABLE 0xFD

// ---------------------------------------------------------------------------
//  Local Variables
// ---------------------------------------------------------------------------

static LCM_UTIL_FUNCS lcm_util = {0};

#define SET_RESET_PIN(v) (lcm_util.set_reset_pin((v)))

#define UDELAY(n) (lcm_util.udelay(n))
#define MDELAY(n) (lcm_util.mdelay(n))

// ---------------------------------------------------------------------------
//  Local Functions
// ---------------------------------------------------------------------------

#define dsi_set_cmdq_V3(ppara, size, force_update)	        	lcm_util.dsi_set_cmdq_V3(ppara, size, force_update)
#define dsi_set_cmdq_V2(cmd, count, ppara, force_update) lcm_util.dsi_set_cmdq_V2(cmd, count, ppara, force_update)
#define dsi_set_cmdq(pdata, queue_size, force_update) lcm_util.dsi_set_cmdq(pdata, queue_size, force_update)
#define wrtie_cmd(cmd) lcm_util.dsi_write_cmd(cmd)
#define write_regs(addr, pdata, byte_nums) lcm_util.dsi_write_regs(addr, pdata, byte_nums)
#define read_reg lcm_util.dsi_read_reg()

// zhoulidong  add for lcm detect ,read adc voltage
#define read_reg_v2(cmd, buffer, buffer_size)                   lcm_util.dsi_dcs_read_lcm_reg_v2(cmd, buffer, buffer_size)
extern int IMM_GetOneChannelValue(int dwChannel, int data[4], int* rawdata);

static LCM_setting_table_V3 lcm_initialization_setting_V3[] = {
    { 0x39, 0xFF, 0x03, {0x98, 0x81, 0x03}},
    { 0x15, 0x01, 0x01, {0x00}},
    { 0x15, 0x02, 0x01, {0x00}},
    { 0x15, 0x03, 0x01, {0x73}},
    { 0x15, 0x04, 0x01, {0x73}},
    { 0x15, 0x05, 0x01, {0x00}},
    { 0x15, 0x06, 0x01, {0x06}},
    { 0x15, 0x07, 0x01, {0x02}},
    { 0x15, 0x08, 0x01, {0x00}},
    { 0x15, 0x09, 0x01, {0x01}},
    { 0x15, 0x0A, 0x01, {0x01}},
    { 0x15, 0x0B, 0x01, {0x01}},
    { 0x15, 0x0C, 0x01, {0x01}},
    { 0x15, 0x0D, 0x01, {0x01}},
    { 0x15, 0x0E, 0x01, {0x01}},
    { 0x15, 0x0F, 0x01, {0x2F}},
    { 0x15, 0x10, 0x01, {0x2F}},
    { 0x15, 0x11, 0x01, {0x00}},
    { 0x15, 0x12, 0x01, {0x00}},
    { 0x15, 0x13, 0x01, {0x01}},
    { 0x15, 0x14, 0x01, {0x00}},
    { 0x15, 0x15, 0x01, {0x00}},
    { 0x15, 0x16, 0x01, {0x00}},
    { 0x15, 0x17, 0x01, {0x00}},
    { 0x15, 0x18, 0x01, {0x00}},
    { 0x15, 0x19, 0x01, {0x00}},
    { 0x15, 0x1A, 0x01, {0x00}},
    { 0x15, 0x1B, 0x01, {0x00}},
    { 0x15, 0x1C, 0x01, {0x00}},
    { 0x15, 0x1D, 0x01, {0x00}},
    { 0x15, 0x1E, 0x01, {0xC0}},
    { 0x15, 0x1F, 0x01, {0x80}},
    { 0x15, 0x20, 0x01, {0x03}},
    { 0x15, 0x21, 0x01, {0x03}},
    { 0x15, 0x22, 0x01, {0x00}},
    { 0x15, 0x23, 0x01, {0x00}},
    { 0x15, 0x24, 0x01, {0x00}},
    { 0x15, 0x25, 0x01, {0x00}},
    { 0x15, 0x26, 0x01, {0x00}},
    { 0x15, 0x27, 0x01, {0x00}},
    { 0x15, 0x28, 0x01, {0x33}},
    { 0x15, 0x29, 0x01, {0x02}},
    { 0x15, 0x2A, 0x01, {0x00}},
    { 0x15, 0x2B, 0x01, {0x00}},
    { 0x15, 0x2C, 0x01, {0x00}},
    { 0x15, 0x2D, 0x01, {0x00}},
    { 0x15, 0x2E, 0x01, {0x00}},
    { 0x15, 0x2F, 0x01, {0x00}},
    { 0x15, 0x30, 0x01, {0x00}},
    { 0x15, 0x31, 0x01, {0x00}},
    { 0x15, 0x32, 0x01, {0x00}},
    { 0x15, 0x33, 0x01, {0x00}},
    { 0x15, 0x34, 0x01, {0x03}},
    { 0x15, 0x35, 0x01, {0x00}},
    { 0x15, 0x36, 0x01, {0x03}},
    { 0x15, 0x37, 0x01, {0x00}},
    { 0x15, 0x38, 0x01, {0x00}},
    { 0x15, 0x39, 0x01, {0x00}},
    { 0x15, 0x3A, 0x01, {0x00}},
    { 0x15, 0x3B, 0x01, {0x00}},
    { 0x15, 0x3C, 0x01, {0x00}},
    { 0x15, 0x3D, 0x01, {0x00}},
    { 0x15, 0x3E, 0x01, {0x00}},
    { 0x15, 0x3F, 0x01, {0x00}},
    { 0x15, 0x40, 0x01, {0x00}},
    { 0x15, 0x41, 0x01, {0x00}},
    { 0x15, 0x42, 0x01, {0x00}},
    { 0x15, 0x43, 0x01, {0x01}},
    { 0x15, 0x44, 0x01, {0x00}},
    { 0x15, 0x50, 0x01, {0x01}},
    { 0x15, 0x51, 0x01, {0x23}},
    { 0x15, 0x52, 0x01, {0x45}},
    { 0x15, 0x53, 0x01, {0x67}},
    { 0x15, 0x54, 0x01, {0x89}},
    { 0x15, 0x55, 0x01, {0xAB}},
    { 0x15, 0x56, 0x01, {0x01}},
    { 0x15, 0x57, 0x01, {0x23}},
    { 0x15, 0x58, 0x01, {0x45}},
    { 0x15, 0x59, 0x01, {0x67}},
    { 0x15, 0x5A, 0x01, {0x89}},
    { 0x15, 0x5B, 0x01, {0xAB}},
    { 0x15, 0x5C, 0x01, {0xCD}},
    { 0x15, 0x5D, 0x01, {0xEF}},
    { 0x15, 0x5E, 0x01, {0x10}},
    { 0x15, 0x5F, 0x01, {0x09}},
    { 0x15, 0x60, 0x01, {0x08}},
    { 0x15, 0x61, 0x01, {0x0F}},
    { 0x15, 0x62, 0x01, {0x0E}},
    { 0x15, 0x63, 0x01, {0x0D}},
    { 0x15, 0x64, 0x01, {0x0C}},
    { 0x15, 0x65, 0x01, {0x02}},
    { 0x15, 0x66, 0x01, {0x02}},
    { 0x15, 0x67, 0x01, {0x02}},
    { 0x15, 0x68, 0x01, {0x02}},
    { 0x15, 0x69, 0x01, {0x02}},
    { 0x15, 0x6A, 0x01, {0x02}},
    { 0x15, 0x6B, 0x01, {0x02}},
    { 0x15, 0x6C, 0x01, {0x02}},
    { 0x15, 0x6D, 0x01, {0x02}},
    { 0x15, 0x6E, 0x01, {0x02}},
    { 0x15, 0x6F, 0x01, {0x02}},
    { 0x15, 0x70, 0x01, {0x02}},
    { 0x15, 0x71, 0x01, {0x06}},
    { 0x15, 0x72, 0x01, {0x07}},
    { 0x15, 0x73, 0x01, {0x02}},
    { 0x15, 0x74, 0x01, {0x02}},
    { 0x15, 0x75, 0x01, {0x06}},
    { 0x15, 0x76, 0x01, {0x07}},
    { 0x15, 0x77, 0x01, {0x0E}},
    { 0x15, 0x78, 0x01, {0x0F}},
    { 0x15, 0x79, 0x01, {0x0C}},
    { 0x15, 0x7A, 0x01, {0x0D}},
    { 0x15, 0x7B, 0x01, {0x02}},
    { 0x15, 0x7C, 0x01, {0x02}},
    { 0x15, 0x7D, 0x01, {0x02}},
    { 0x15, 0x7E, 0x01, {0x02}},
    { 0x15, 0x7F, 0x01, {0x02}},
    { 0x15, 0x80, 0x01, {0x02}},
    { 0x15, 0x81, 0x01, {0x02}},
    { 0x15, 0x82, 0x01, {0x02}},
    { 0x15, 0x83, 0x01, {0x02}},
    { 0x15, 0x84, 0x01, {0x02}},
    { 0x15, 0x85, 0x01, {0x02}},
    { 0x15, 0x86, 0x01, {0x02}},
    { 0x15, 0x87, 0x01, {0x09}},
    { 0x15, 0x88, 0x01, {0x08}},
    { 0x15, 0x89, 0x01, {0x02}},
    { 0x15, 0x8A, 0x01, {0x02}},
    { 0x39, 0xFF, 0x03, {0x98, 0x81, 0x04}},
    { 0x15, 0x00, 0x01, {0x00}},
    { 0x15, 0x6C, 0x01, {0x15}},
    { 0x15, 0x6E, 0x01, {0x2A}},
    { 0x15, 0x6F, 0x01, {0x57}},
    { 0x15, 0x3A, 0x01, {0xA4}},
    { 0x15, 0x8D, 0x01, {0x1A}},
    { 0x15, 0x87, 0x01, {0xBA}},
    { 0x15, 0x26, 0x01, {0x76}},
    { 0x15, 0xB2, 0x01, {0xD1}},
    { 0x15, 0x88, 0x01, {0x0B}},
    { 0x15, 0x3C, 0x01, {0x81}},
    { 0x39, 0xFF, 0x03, {0x98, 0x81, 0x01}},
    { 0x15, 0x22, 0x01, {0x0A}},
    { 0x15, 0x31, 0x01, {0x00}},
    { 0x15, 0x50, 0x01, {0xA8}},
    { 0x15, 0x51, 0x01, {0xA8}},
    { 0x15, 0x60, 0x01, {0x06}},
    { 0x15, 0x62, 0x01, {0x20}},
    { 0x15, 0xA0, 0x01, {0x00}},
    { 0x15, 0xA1, 0x01, {0x22}},
    { 0x15, 0xA2, 0x01, {0x36}},
    { 0x15, 0xA3, 0x01, {0x18}},
    { 0x15, 0xA4, 0x01, {0x1E}},
    { 0x15, 0xA5, 0x01, {0x32}},
    { 0x15, 0xA6, 0x01, {0x27}},
    { 0x15, 0xA7, 0x01, {0x25}},
    { 0x15, 0xA8, 0x01, {0xA6}},
    { 0x15, 0xA9, 0x01, {0x1D}},
    { 0x15, 0xAA, 0x01, {0x28}},
    { 0x15, 0xAB, 0x01, {0x7D}},
    { 0x15, 0xAC, 0x01, {0x1A}},
    { 0x15, 0xAD, 0x01, {0x19}},
    { 0x15, 0xAE, 0x01, {0x4D}},
    { 0x15, 0xAF, 0x01, {0x23}},
    { 0x15, 0xB0, 0x01, {0x2B}},
    { 0x15, 0xB1, 0x01, {0x49}},
    { 0x15, 0xB2, 0x01, {0x55}},
    { 0x15, 0xB3, 0x01, {0x23}},
    { 0x15, 0xC0, 0x01, {0x00}},
    { 0x15, 0xC1, 0x01, {0x22}},
    { 0x15, 0xC2, 0x01, {0x36}},
    { 0x15, 0xC3, 0x01, {0x18}},
    { 0x15, 0xC4, 0x01, {0x1E}},
    { 0x15, 0xC5, 0x01, {0x32}},
    { 0x15, 0xC6, 0x01, {0x27}},
    { 0x15, 0xC7, 0x01, {0x25}},
    { 0x15, 0xC8, 0x01, {0xA6}},
    { 0x15, 0xC9, 0x01, {0x1D}},
    { 0x15, 0xCA, 0x01, {0x28}},
    { 0x15, 0xCB, 0x01, {0x7D}},
    { 0x15, 0xCC, 0x01, {0x1A}},
    { 0x15, 0xCD, 0x01, {0x19}},
    { 0x15, 0xCE, 0x01, {0x4D}},
    { 0x15, 0xCF, 0x01, {0x23}},
    { 0x15, 0xD0, 0x01, {0x2B}},
    { 0x15, 0xD1, 0x01, {0x49}},
    { 0x15, 0xD2, 0x01, {0x55}},
    { 0x15, 0xD3, 0x01, {0x14}},
    { 0x39, 0xFF, 0x03, {0x98, 0x81, 0x00}},
    { 0x15, 0x35, 0x01, {0x00}},
    { 0x05, 0x11, 0x01, {0x00}},
    { REGFLAG_ESCAPE_ID, REGFLAG_DELAY_MS_V3, 0x78, {0x00}},
    { 0x05, 0x29, 0x01, {0x00}},
    { REGFLAG_ESCAPE_ID, REGFLAG_DELAY_MS_V3, 0x14, {0x00}},
};


static LCM_setting_table_V3 lcm_deep_sleep_mode_in_setting_V3[] = {
    { 0x39, 0xFF, 0x03, {0x98, 0x81, 0x01}},
    { 0x15, 0xB3, 0x01, {0x3F}},
    { 0x15, 0xD3, 0x01, {0x3F}},
    { 0x39, 0xFF, 0x03, {0x98, 0x81, 0x04}},
    { 0x15, 0x2D, 0x01, {0x01}},
    { 0x15, 0x2F, 0x01, {0x01}},
    { REGFLAG_ESCAPE_ID, REGFLAG_DELAY_MS_V3, 0xC8, {0x00}},
    { 0x15, 0x2F, 0x01, {0x00}},
    { 0x39, 0xFF, 0x03, {0x98, 0x81}},
    { 0x05, 0x28, 0x00, {0x00}},
    { REGFLAG_ESCAPE_ID, REGFLAG_DELAY_MS_V3, 0x0A, {0x00}},
    { 0x05, 0x10, 0x00, {0x00}},
    { REGFLAG_ESCAPE_ID, REGFLAG_DELAY_MS_V3, 0x78, {0x00}},
    { 0x39, 0xFF, 0x03, {0x98, 0x81}},
    { 0x15, 0x58, 0x01, {0x01}},
};

// ---------------------------------------------------------------------------
//  LCM Driver Implementations
// ---------------------------------------------------------------------------
static void lcm_set_util_funcs(const LCM_UTIL_FUNCS *util)
{
    memcpy(&lcm_util, util, sizeof(LCM_UTIL_FUNCS));
}

static void lcm_get_params(LCM_PARAMS *params)
{
  memset(params, 0, sizeof(LCM_PARAMS));

  params->physical_width = 62;
  params->physical_height = 110;
  params->dsi.LANE_NUM = 3;
  params->dsi.vertical_sync_active = 8;
  params->dsi.vertical_backporch = 6;
  params->dsi.vertical_frontporch = 4;
  params->dsi.horizontal_sync_active = 26;
  params->dsi.horizontal_backporch = 24;
  params->dsi.horizontal_frontporch = 38;
  params->dsi.PLL_CLOCK = 245;
  params->dsi.fbk_div = 7;
  params->dsi.lcm_esd_check_table[0].cmd = 10;
  params->dsi.lcm_esd_check_table[0].para_list[0] = 0x9Cu;
  params->type = 2;
  params->dsi.data_format.format = 2;
  params->dsi.PS = 2;
  params->width = 720;
  params->dsi.horizontal_active_pixel = 720;
  params->height = 1280;
  params->dsi.vertical_active_line = 1280;
  params->dsi.mode = 1;
  params->dsi.esd_check_enable = 1;
  params->dsi.customization_esd_check_enable = 1;
  params->dsi.lcm_esd_check_table[0].count = 1;
  params->dsi.pll_div1 = 0;
  params->dsi.pll_div2 = 0;
}

static void lcm_init(void)
{
  SET_RESET_PIN(1);
  SET_RESET_PIN(0);
  MDELAY(10);
  SET_RESET_PIN(1);
  MDELAY(120);
  dsi_set_cmdq_V3(lcm_initialization_setting_V3, sizeof(lcm_initialization_setting_V3) / sizeof(LCM_setting_table_V3), 1);
}

static void lcm_suspend(void)
{
  dsi_set_cmdq_V3(lcm_deep_sleep_mode_in_setting_V3, sizeof(lcm_deep_sleep_mode_in_setting_V3) / sizeof(LCM_setting_table_V3), 1);
  SET_RESET_PIN(1);
  SET_RESET_PIN(0);
  MDELAY(20);
  SET_RESET_PIN(1);
  MDELAY(120);
}

static void lcm_resume(void)
{
  lcm_init();
}

/*
static unsigned int lcm_compare_id(void)
{
  return 1;

  int v0;
  int v1;
  unsigned int v2;
  char v3;
  unsigned int result;
  int v5;
  int v6;
  int v7;
  int v8;
  int v9;
  int data_array[4];
  int v11;
  int v12;

  v7 = 0;
  v6 = 0;
  v8 = 0;
  v9 = 0;
  v5 = 0;
  v11 = 0;
  v12 = 0;
  SET_RESET_PIN(1);
  SET_RESET_PIN(0);
  MDELAY(10);
  SET_RESET_PIN(1);
  MDELAY(120);
  data_array[0] = 0x43902;
  data_array[1] = 0x18198FF;
  (g_LCM_UTIL_FUNCS.dsi_set_cmdq)(data_array, 2, 1);
  data_array[0] = 0x23700;
  (g_LCM_UTIL_FUNCS.dsi_set_cmdq)(data_array, 1, 1);
  MDELAY(1);
  (g_LCM_UTIL_FUNCS.dsi_dcs_read_lcm_reg_v2)(0, &v11, 2);
  data_array[0] = 0x23700;
  v0 = v11;
  (g_LCM_UTIL_FUNCS.dsi_set_cmdq)(data_array, 1, 1);
  MDELAY(1);
  (g_LCM_UTIL_FUNCS.dsi_dcs_read_lcm_reg_v2)(1, &v11, 2);
  v1 = v11 | (v0 << 8);
  printf(" ILI9881 TXD LK read id=0x%x, id1=0x%x, id2=0x%x", v1, v0, v11);
  if ( sub_C04ACA48(12, &v6, &v5) < 0 )
  {
    printf("read adc error");
    result = 0;
  }
  else
  {
    v2 = 10 * v7 + 1000 * v6 - 500;
    printf("[adc_uboot]: lcm_vol= %d\n");
    v3 = v2 == 500;
    if ( v2 <= 0x1F4 )
      v3 = v1 == 0x9881;
    if ( v3 )
      result = 1;
    else
      result = 0;
  }
  if ( v12 )
    _und_0x10();
  return result;
}
*/

static unsigned int rgk_lcm_compare_id(void)
{
     int data[4] = {0,0,0,0};
    int res = 0;
    int rawdata = 0;
    int lcm_vol = 0;

	int array[4];
	char buffer[4]={0,0,0,0};
	char id_high=0;
	char id_low=0;
	int id=0;

	SET_RESET_PIN(1);
	SET_RESET_PIN(0);
	MDELAY(10);
	SET_RESET_PIN(1);
	MDELAY(120);

	array[0]= 0x00043902;
	array[1]= 0x018198FF;
	dsi_set_cmdq(array, 2, 1);

	array[0] = 0x00023700;// read id return 2 bytes,version and id
	dsi_set_cmdq(array, 1, 1);
	MDELAY(1);
	read_reg_v2(0x00, buffer, 2);
	id_high = buffer[0];

	array[0] = 0x00023700;// read id return 2 bytes,version and id
	dsi_set_cmdq(array, 1, 1);
	MDELAY(1);
	read_reg_v2(0x01, buffer, 2);
	id_low = buffer[0];

	id = (id_high<<8) | id_low;


#ifdef BUILD_LK
	printf(" ILI9881 TXD LK read id=0x%x, id1=0x%x, id2=0x%x",id, id_high,id_low);
#else
    printk(" ILI9881 TXD LK read id=0x%x, id1=0x%x, id2=0x%x",id, id_high,id_low);
#endif

#ifdef AUXADC_LCM_VOLTAGE_CHANNEL
    res = IMM_GetOneChannelValue(AUXADC_LCM_VOLTAGE_CHANNEL,data,&rawdata);
    if(res < 0)
    {
   #ifdef BUILD_LK
    printf("read adc error");
   #else
   printk("read adc error");
   #endif
    return 0;

    }
#endif
    lcm_vol = data[0]*1000+data[1]*10;
#ifdef BUILD_LK
   	printf("[adc_uboot]: lcm_vol= %d\n",lcm_vol);
#else
    printk("[adc_uboot]: lcm_vol= %d\n",lcm_vol);
#endif
    if ((lcm_vol>=MIN_VOLTAGE &&lcm_vol <= MAX_VOLTAGE )&&(LCM_ID_ILI9881==id))
    {
    return 1;
    }
    return 0;
}


LCM_DRIVER ili9881c_hd_dsi_vdo_3lanes_txd_lcm_drv =
    {
        .name = "ili9881c_hd_dsi_vdo_3lanes_txd",
        .set_util_funcs = lcm_set_util_funcs,
        .get_params = lcm_get_params,
        .init = lcm_init,
        .suspend = lcm_suspend,
        .resume = lcm_resume,
        .compare_id = rgk_lcm_compare_id,
//    .compare_id     = lcm_compare_id,
};
